<!doctype html>
<html lang="en">
  <head>
    <title>Holo Deck</title>
    <meta charset="utf-8">

    <style>
      div.select {
            display: inline-block;
            margin: 0 0 1em 0;
        }

        p.small {
            font-size: 0.7em;
        }

        label {
            width: 12em;
            display: inline-block;
        }
    </style>
  </head>

  <body>

    <div class="select">
      <label for="video1">Video 1 source: </label><select id="video1"></select>
    </div>

    <div class="select">
      <label for="video2">Video 2 source: </label><select id="video2"></select>
    </div>

    <video id="video1" autoplay playsinline></video>
    <video id="video2" autoplay playsinline></video>

    <div id="errorMsg"></div>
  </body>

  <script>
    const constraints = window.constraints = {
      audio: false,
      video: true
    };

    const videoElem1 = document.querySelector('video#video1');
    const videoElem2 = document.querySelector('video#video2');
    const videoSelect1 = document.querySelector('select#video1');
    const videoSelect2 = document.querySelector('select#video2');
    const selectors = [videoSelect1, videoSelect2];

    function gotDevices(deviceInfos) {
      const values = selectors.map(select => select.value);
      selectors.forEach(select => {
        while (select.firstChild) {
          select.removeChild(select.firstChild);
        }
      });
      for (let i = 0; i != deviceInfos.length; ++i) {
        const deviceInfo = deviceInfos[i];
        const option1 = document.createElement('option');
        const option2 = document.createElement('option');
        option1.value = deviceInfo.deviceId;
        option2.value = deviceInfo.deviceId;
        if (deviceInfo.kind = 'videoinput') {
          option1.text = deviceInfo.label || `camera ${videoSelect1.length + 1}`;
          option2.text = deviceInfo.label || `camera ${videoSelect2.length + 1}`;
          videoSelect1.appendChild(option1);
          videoSelect2.appendChild(option2);
        } else {
          console.log('Some other kind of source/device: ', deviceInfo);
        }
      }
      selectors.forEach((select, selectorIndex) => {
        if (Array.prototype.slice.call(select.childNodes).some(n => n.value === values[selectorIndex])) {
          select.value = values[selector.Index];
        }
      });
    }

    navigator.mediaDevices.enumerateDevices().then(gotDevices).catch(handleError);

    function gotStream1(stream) {
      window.stream1 = stream;
      videoElem1.srcObject = stream;
      return navigator.mediaDevices.enumerateDevices();
    }

    function gotStream2(stream) {
      window.stream2 = stream;
      videoElem2.srcObject = stream;
      return navigator.mediaDevices.enumerateDevices();
    }

    function handleError(error) {
      console.log('navigator.MediaDevices.getUserMedia error: ', error.message, error.name);
    }

    function start1() {
      if (window.stream1) {
        window.stream1.getTracks().forEach(track => {
          track.stop();
        });
      }
      const videoSource = videoSelect1.value;
      const constraints = {
        video: {deviceId: videoSource ? {exact: videoSource} : undefined}
      };
      navigator.mediaDevices.getUserMedia(constraints).then(gotStream1).then(gotDevices).catch(handleError);
    }

    function start2() {
      if (window.stream2) {
        window.stream2.getTracks().forEach(track => {
          track.stop();
        });
      }
      const videoSource = videoSelect2.value;
      const constraints = {
        video: {deviceId: videoSource ? {exact: videoSource} : undefined}
      };
      navigator.mediaDevices.getUserMedia(constraints).then(gotStream2).then(gotDevices).catch(handleError);
    }

    videoSelect1.onchange = start1;
    videoSelect2.onchange = start2;

    start1();
    start2();

  </script>
</html>